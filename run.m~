function alignHistology(varargin)
if empty(vara
% % disp('Select histology directory...');
% % histoDir = uigetdir();
tifFiles = dir(fullfile(histoDir,'*.TIF'));

% sort by date
datenums = cell2mat({tifFiles(:).datenum});
[~,idx] = sort(datenums);
tifFiles = {tifFiles(idx).name};

% compress images
compressedDir = fullfile(histoDir,'compressed');
if ~isdir(compressedDir)
    h = waitbar(0,'Compressing Images');
    mkdir(compressedDir);
    for iTif = 1:length(tifFiles)
        waitbar(iTif/length(tifFiles),h,'Compressing Images');
        A = imread(fullfile(histoDir,tifFiles{iTif}));
        A = imresize(A,0.5);
        A = autocontrast(A);
        imwrite(A,fullfile(compressedDir,[tifFiles{iTif},'.jpeg']));
    end
    close(h);
end

jpegFiles = dir(fullfile(compressedDir,'*.jpeg'));
jpegFiles = natsort({jpegFiles.name});

imageIds = [];
while length(imageIds) < 2
    imageIds = listdlg('PromptString','Select starting file:',...
                'SelectionMode','multiple','ListSize',[200 600],...
                'ListString',jpegFiles);
end

iImage = 1;
initMag = 25;
while iImage < length(jpegFiles)
    if iImage == 1
        IM1 = imread(fullfile(compressedDir,jpegFiles{imageIds(iImage)}));
        h = figure;
        imshow(IM1,'InitialMagnification',initMag);
        choice = questdlg('Flip horizontal?','','No','Yes','No');
        switch choice
            case 'Yes'
                IM1 = flip(IM1,2);
                imshow(IM1,'InitialMagnification',initMag);
        end
        
        doRotate = true;
        imRot = 0;
        IMtemp = IM1;
        while doRotate
            choice = questdlg('Rotate?','','Keep','Clockwise','Counter Clockwise','Keep');
            switch choice
                case 'Keep'
                    doRotate = false;
                case 'Clockwise'
                    imRot = imRot - 10;
                    IMtemp = imrotate(IM1,imRot);
                    imshow(IMtemp,'InitialMagnification',initMag);
                case 'Counter Clockwise'
                    imRot = imRot + 10;
                    IMtemp = imrotate(IM1,imRot);
                    imshow(IMtemp,'InitialMagnification',initMag);
            end
        end
        IM1 = IMtemp;
        close(h);
        
        orientatedDir = fullfile(compressedDir,'orientated');
        if ~isdir(orientatedDir)
            mkdir(orientatedDir);
        end
        imwrite(IM1,fullfile(orientatedDir,jpegFiles{imageIds(iImage)}));
        
        h = msgbox('Select 4 or more control points. Press cmd/cntl+W after selection of points.');
        uiwait(h);
    else
        IM1 = IM2registered;
    end
    
    IM2 = imread(fullfile(compressedDir,jpegFiles{imageIds(iImage+1)}));
    [moving_out,fixed_out] = cpselect(IM2,IM1,'Wait',true);
    if length(moving_out) >= 4
        mytform = fitgeotrans(moving_out,fixed_out,'projective');
        rIM1 = imref2d(size(IM1));
        IM2registered = imwarp(IM2,mytform,'OutputView',rIM2);
        h = figure; 
        imshowpair(IM2registered,IM1,'blend');
        choice = questdlg('How does it look?','','Keep','Redo','Skip','Keep');
        switch choice
            case 'Keep'
                imwrite(IM2registered,fullfile(orientatedDir,jpegFiles{imageIds(iImage+1)}));
                iImage = iImage + 1;
            case 'Redo'
                continue;
            case 'Skip'
                iImage = iImage + 1;
        end
        close(h);
    else
        choice = questdlg('You must have 4 or more control points.','','Skip','Redo','Exit','Skip');
        switch choice
            case 'Skip'
                iImage = iImage + 1;
            case 'Redo'
                continue;
            case 'Exit'
                break;
        end
    end
    
    %are there at least 4 control points?
    %does the registration look good?
    
%     registered = imwarp(IM2, mytform);
%     figure;imshow(registered);
end

% can I automatically flip the image based on points? I think...
% save in compressed > orientated

% how does this handle canvas size? Will it come into photoshop okay? Do I
% need to increase canvas size so it rotates correctly?